<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module 8: Reactive vs Pre-Planned - ADIZ Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      color: #667eea;
      margin-bottom: 8px;
    }
    
    .header p {
      color: #666;
      margin-bottom: 15px;
    }
    
    .explanation-box {
      background: #f0f4ff;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      font-size: 0.95rem;
      line-height: 1.6;
      color: #333;
    }
    
    .explanation-box strong {
      color: #667eea;
    }
    
    .nav {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    
    .nav a {
      text-decoration: none;
      color: #667eea;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 8px;
      background: #f0f4ff;
    }
    
    .nav a:hover {
      background: #667eea;
      color: white;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #667eea;
      margin-bottom: 20px;
    }
    
    .controls {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .control-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .control-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .control-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 60px;
      font-size: 1.3rem;
      color: #667eea;
    }
    
    .loading.active {
      display: block;
    }
    
    .results {
      display: none;
    }
    
    .verdict-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      text-align: center;
    }
    
    .verdict-box h3 {
      font-size: 2rem;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    
    .verdict-box .confidence {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    
    .verdict-box .scores {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .score-card {
      background: rgba(255, 255, 255, 0.15);
      padding: 15px;
      border-radius: 10px;
    }
    
    .score-card .label {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .score-card .value {
      font-size: 2rem;
      font-weight: 700;
    }
    
    .evidence-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .evidence-box h3 {
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .evidence-box pre {
      white-space: pre-wrap;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 0.95rem;
      line-height: 1.8;
      color: #333;
    }
    
    .signal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .signal-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border-left: 5px solid #667eea;
    }
    
    .signal-card h4 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .signal-card .result {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .signal-card .explanation {
      font-size: 0.9rem;
      color: #666;
      line-height: 1.5;
    }
    
    .signal-card.reactive {
      border-left-color: #10b981;
    }
    
    .signal-card.preplanned {
      border-left-color: #ef4444;
    }
    
    .signal-card.neutral {
      border-left-color: #f59e0b;
    }
    
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .chart-container h3 {
      color: #667eea;
      margin-bottom: 15px;
    }
    
    #eventCounter {
      color: #666;
      font-size: 0.9rem;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîç Module 8: Reactive vs Pre-Planned Classifier</h1>
    <p>Determine if PLA response was triggered by event or pre-planned and using event as excuse</p>
    
    <div class="explanation-box">
      <strong>üéØ What This Module Does:</strong><br>
      This classifier analyzes multiple statistical and temporal signals to determine whether a PLA ADIZ response was:
      <ul style="margin: 10px 0 10px 25px;">
        <li><strong>REACTIVE:</strong> Genuinely triggered by the U.S./Taiwan action (immediate spike, no pre-buildup)</li>
        <li><strong>PRE-PLANNED:</strong> Already scheduled, just using event as excuse/justification (delayed, pre-buildup, sustained)</li>
        <li><strong>MIXED:</strong> Combination of both (opportunistic timing)</li>
      </ul>
      
      <strong style="color: #667eea;">Analysis Method:</strong><br>
      We examine 5 signals with statistical weights:
      <ol style="margin: 10px 0 10px 25px;">
        <li><strong>Temporal Proximity (30%):</strong> How quickly did response occur? (0-2 days = reactive, 9+ days = pre-planned)</li>
        <li><strong>Pre-Event Buildup (25%):</strong> Was ADIZ rising before the event? (rising trend = pre-planning)</li>
        <li><strong>Magnitude (20%):</strong> Is response unusually large? (very large ops need advance planning)</li>
        <li><strong>Symbolic Timing (15%):</strong> Aligned with symbolic dates? (Oct 10, PRC National Day, etc.)</li>
        <li><strong>Pattern Shape (10%):</strong> Sharp spike or sustained plateau? (spike = reactive, plateau = planned exercise)</li>
      </ol>
      
      <strong style="color: #667eea;">Example:</strong> Pelosi visit (Aug 2022) would likely score as REACTIVE (immediate massive spike, no pre-buildup). 
      Joint Sword exercises around Taiwan inauguration might score PRE-PLANNED (scheduled around symbolic date, sustained operation).
    </div>
    
    <div class="nav">
      <a href="index.html">‚Üê Home</a>
      <a href="visualizer.html">Visualizer</a>
      <a href="analyzers.html">Module 1</a>
      <a href="module2.html">Module 2</a>
      <a href="module3.html">Module 3</a>
    </div>
  </div>

  <div class="container">
    <h2>Select Event to Classify</h2>
    
    <div class="controls">
      <div class="control-row">
        <div class="control-group">
          <label>Event Category</label>
          <select id="categorySelect">
            <option value="">-- Select category --</option>
            <option value="arms">Arms Sales</option>
            <option value="diplomatic">Diplomatic</option>
            <option value="ships">Ship Transits</option>
            <option value="bills">Legislative Bills</option>
            <option value="political">Political/Symbolic</option>
          </select>
        </div>
        
        <div class="control-group">
          <label>Year Filter</label>
          <select id="yearSelect">
            <option value="ALL">All Years</option>
          </select>
        </div>
      </div>
      
      <div class="control-group">
        <label>Select Specific Event</label>
        <select id="eventSelect">
          <option value="">-- Select an event --</option>
        </select>
        <span id="eventCounter"></span>
      </div>
      
      <button onclick="runClassification()">üîç Classify Event</button>
    </div>
    
    <div class="loading" id="loading">
      üîç Analyzing signals...
    </div>
    
    <div id="results" class="results">
      <!-- Verdict Box -->
      <div class="verdict-box">
        <h3 id="verdict">REACTIVE</h3>
        <div class="confidence" id="confidence">High Confidence</div>
        <div class="scores">
          <div class="score-card">
            <div class="label">Reactive Probability</div>
            <div class="value" id="reactiveScore">85%</div>
          </div>
          <div class="score-card">
            <div class="label">Pre-Planned Probability</div>
            <div class="value" id="preplannedScore">15%</div>
          </div>
        </div>
      </div>
      
      <!-- Evidence Summary -->
      <div class="evidence-box">
        <h3>üìã Evidence Summary</h3>
        <pre id="evidenceSummary"></pre>
      </div>
      
      <!-- Signal Breakdown -->
      <h3 style="color: #667eea; margin-bottom: 20px;">üî¨ Signal Analysis</h3>
      <div class="signal-grid" id="signalGrid">
        <!-- Signal cards will be inserted here -->
      </div>
      
      <!-- Charts -->
      <div class="chart-container">
        <h3>üìä Signal Strength Breakdown</h3>
        <p style="color: #666; margin-bottom: 15px;">
          Shows how each signal votes: Green (reactive) vs Red (pre-planned)
        </p>
        <div id="signalChart"></div>
      </div>
      
      <div class="chart-container">
        <h3>üìà Pre-Event ADIZ Trend</h3>
        <p style="color: #666; margin-bottom: 15px;">
          Shows ADIZ activity in the 21 days before the event. Rising trend suggests pre-planning.
        </p>
        <div id="trendChart"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import PreplannedReactive from './js/analyzers/preplannedReactive.js';
    import DataConnector from './js/core/dataConnector.js';
    
    let currentEvents = [];
    
    // Initialize
    async function init() {
      await loadEmbeddedData();
    }
    
    async function loadEmbeddedData() {
      try {
        const response = await fetch('./visualizer.html');
        const htmlContent = await response.text();
        const dataMatch = htmlContent.match(/const DATA\s*=\s*(\{[\s\S]*?\});/);
        const DATA = new Function('return ' + dataMatch[1])();
        
        DataConnector.loadFromObject(DATA);
        setupUI();
      } catch (error) {
        alert('Error loading data: ' + error.message);
      }
    }
    
    function setupUI() {
      // Populate year dropdown
      const years = DataConnector.getAvailableYears().slice(1);
      const yearSelect = document.getElementById('yearSelect');
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });
      
      // Event listeners
      document.getElementById('categorySelect').addEventListener('change', updateEventList);
      document.getElementById('yearSelect').addEventListener('change', updateEventList);
    }
    
    function updateEventList() {
      const category = document.getElementById('categorySelect').value;
      const year = document.getElementById('yearSelect').value;
      
      if (!category) {
        document.getElementById('eventSelect').innerHTML = '<option value="">-- Select category first --</option>';
        document.getElementById('eventCounter').textContent = '';
        return;
      }
      
      const filters = { category };
      if (year !== 'ALL') filters.year = year;
      
      currentEvents = DataConnector.getEvents(filters);
      
      const eventSelect = document.getElementById('eventSelect');
      eventSelect.innerHTML = '<option value="">-- Select an event --</option>';
      
      currentEvents.forEach((event, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${event.date} - ${event.label}`;
        eventSelect.appendChild(option);
      });
      
      document.getElementById('eventCounter').textContent = `${currentEvents.length} events available`;
    }
    
    window.runClassification = function() {
      const eventIndex = document.getElementById('eventSelect').value;
      
      if (eventIndex === '') {
        alert('Please select an event');
        return;
      }
      
      const event = currentEvents[parseInt(eventIndex)];
      
      document.getElementById('loading').classList.add('active');
      document.getElementById('results').style.display = 'none';
      
      setTimeout(() => {
        try {
          const analysis = PreplannedReactive.classify(event, { windowSize: 21 });
          displayResults(analysis);
          
          document.getElementById('loading').classList.remove('active');
          document.getElementById('results').style.display = 'block';
        } catch (error) {
          document.getElementById('loading').classList.remove('active');
          alert('Error: ' + error.message);
        }
      }, 500);
    };
    
    function displayResults(analysis) {
      const { classification, signals } = analysis;
      
      // Verdict box
      document.getElementById('verdict').textContent = classification.verdict.toUpperCase();
      document.getElementById('confidence').textContent = `${classification.confidence.toUpperCase()} Confidence`;
      document.getElementById('reactiveScore').textContent = (classification.reactiveScore * 100).toFixed(0) + '%';
      document.getElementById('preplannedScore').textContent = (classification.prePlannedScore * 100).toFixed(0) + '%';
      
      // Evidence summary
      document.getElementById('evidenceSummary').textContent = classification.summary;
      
      // Signal cards
      displaySignalCards(signals);
      
      // Charts
      plotSignalBreakdown();
      plotPreEventTrend();
    }
    
    function displaySignalCards(signals) {
      const grid = document.getElementById('signalGrid');
      grid.innerHTML = '';
      
      const signalData = [
        {
          title: '‚è±Ô∏è Temporal Proximity',
          signal: signals.temporal,
          key: 'temporal'
        },
        {
          title: 'üìà Pre-Event Buildup',
          signal: signals.buildup,
          key: 'buildup'
        },
        {
          title: 'üí™ Magnitude',
          signal: signals.magnitude,
          key: 'magnitude'
        },
        {
          title: 'üéØ Symbolic Timing',
          signal: signals.symbolic,
          key: 'symbolic'
        },
        {
          title: 'üìâ Pattern Shape',
          signal: signals.pattern,
          key: 'pattern'
        }
      ];
      
      signalData.forEach(({ title, signal }) => {
        const card = document.createElement('div');
        
        let cardClass = 'signal-card';
        if (signal.reactiveScore > 0.6) cardClass += ' reactive';
        else if (signal.reactiveScore < 0.4) cardClass += ' preplanned';
        else cardClass += ' neutral';
        
        let result = '';
        if (signal.reactiveScore > 0.6) result = '‚úÖ Supports REACTIVE';
        else if (signal.reactiveScore < 0.4) result = '‚ùå Supports PRE-PLANNED';
        else result = '‚ö†Ô∏è Neutral/Ambiguous';
        
        card.className = cardClass;
        card.innerHTML = `
          <h4>${title}</h4>
          <div class="result">${result}</div>
          <div class="explanation">${signal.explanation}</div>
        `;
        
        grid.appendChild(card);
      });
    }
    
    function plotSignalBreakdown() {
      const data = PreplannedReactive.getSignalBreakdown();
      
      const trace = {
        x: data.labels,
        y: data.reactiveScores,
        type: 'bar',
        marker: {
          color: data.reactiveScores.map(score => {
            if (score > 0.6) return '#10b981'; // Green = reactive
            if (score < 0.4) return '#ef4444'; // Red = pre-planned
            return '#f59e0b'; // Orange = neutral
          })
        },
        text: data.reactiveScores.map(s => (s * 100).toFixed(0) + '%'),
        textposition: 'outside'
      };
      
      const layout = {
        yaxis: {
          title: 'Reactive Score',
          range: [0, 1],
          tickformat: ',.0%'
        },
        shapes: [
          // Green zone
          {
            type: 'rect',
            xref: 'paper',
            x0: 0,
            x1: 1,
            y0: 0.6,
            y1: 1,
            fillcolor: '#10b981',
            opacity: 0.1,
            line: { width: 0 }
          },
          // Red zone
          {
            type: 'rect',
            xref: 'paper',
            x0: 0,
            x1: 1,
            y0: 0,
            y1: 0.4,
            fillcolor: '#ef4444',
            opacity: 0.1,
            line: { width: 0 }
          }
        ],
        annotations: [
          {
            x: 0.5,
            y: 0.8,
            xref: 'paper',
            yref: 'y',
            text: 'Reactive Zone',
            showarrow: false,
            font: { color: '#10b981', size: 10 }
          },
          {
            x: 0.5,
            y: 0.2,
            xref: 'paper',
            yref: 'y',
            text: 'Pre-Planned Zone',
            showarrow: false,
            font: { color: '#ef4444', size: 10 }
          }
        ],
        height: 400
      };
      
      Plotly.newPlot('signalChart', [trace], layout);
    }
    
    function plotPreEventTrend() {
      const data = PreplannedReactive.getPreEventTrendData();
      
      const trace = {
        x: data.days,
        y: data.adiz,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'ADIZ',
        line: { color: '#667eea', width: 2 },
        marker: { size: 6 }
      };
      
      const eventLine = {
        x: [0, 0],
        y: [0, Math.max(...data.adiz) * 1.1],
        type: 'scatter',
        mode: 'lines',
        name: 'Event Date',
        line: { color: 'green', width: 2, dash: 'dot' }
      };
      
      const layout = {
        xaxis: { 
          title: 'Days Before Event',
          range: [Math.min(...data.days) - 1, 1]
        },
        yaxis: { title: 'ADIZ Count' },
        hovermode: 'x unified',
        height: 400
      };
      
      Plotly.newPlot('trendChart', [trace, eventLine], layout);
    }
    
    init();
  </script>
</body>
</html>
