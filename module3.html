<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module 3: A/B Comparison - ADIZ Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      color: #667eea;
      margin-bottom: 8px;
    }
    
    .header p {
      color: #666;
      margin-bottom: 15px;
    }
    
    .nav {
      display: flex;
      gap: 15px;
    }
    
    .nav a {
      text-decoration: none;
      color: #667eea;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 8px;
      background: #f0f4ff;
    }
    
    .nav a:hover {
      background: #667eea;
      color: white;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #667eea;
      margin-bottom: 20px;
    }
    
    .comparison-setup {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 968px) {
      .comparison-setup {
        grid-template-columns: 1fr;
      }
    }
    
    .group-panel {
      border: 3px solid #667eea;
      border-radius: 12px;
      padding: 20px;
      background: #f8f9fa;
    }
    
    .group-panel.group-b {
      border-color: #764ba2;
    }
    
    .group-panel h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .group-panel.group-b h3 {
      color: #764ba2;
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }
    
    .control-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      font-size: 0.95rem;
    }
    
    .subfilter-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #ddd;
    }
    
    .subfilter-section h4 {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 10px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px 40px;
      border-radius: 10px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 60px;
      font-size: 1.3rem;
      color: #667eea;
    }
    
    .loading.active {
      display: block;
    }
    
    .results {
      display: none;
    }
    
    .recommendation-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .recommendation-box h3 {
      font-size: 1.3rem;
      margin-bottom: 12px;
    }
    
    .recommendation-box .summary {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .recommendation-box .details {
      font-size: 0.95rem;
      line-height: 1.6;
      opacity: 0.95;
    }
    
    .recommendation-box .details li {
      margin-bottom: 8px;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
      .comparison-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .group-stats {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
    }
    
    .group-stats.group-a {
      border-left: 5px solid #667eea;
    }
    
    .group-stats.group-b {
      border-left: 5px solid #764ba2;
    }
    
    .group-stats h3 {
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .group-stats.group-b h3 {
      color: #764ba2;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .stat-row:last-child {
      border-bottom: none;
    }
    
    .stat-label {
      font-weight: 600;
      color: #555;
    }
    
    .stat-value {
      font-weight: 700;
      color: #333;
      font-size: 1.1rem;
    }
    
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .chart-container h3 {
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .event-counter {
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #666;
      margin-top: 8px;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      margin-left: 5px;
      color: #667eea;
      font-size: 0.9rem;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 280px;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 8px;
      padding: 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -140px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
      line-height: 1.4;
      font-weight: normal;
    }
    
    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    .button-container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin: 30px 0;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }
    
    .button-container p {
      text-align: center;
      color: #666;
      margin-bottom: 15px;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚öñÔ∏è Module 3: A/B Comparison</h1>
    <p>Compare two event groups side-by-side to see which triggers stronger ADIZ reactions</p>
    
    <div style="background: #f0f4ff; padding: 20px; border-radius: 12px; margin-top: 20px; font-size: 0.95rem; color: #333; line-height: 1.6;">
      <strong style="color: #667eea; font-size: 1.05rem;">üìä What This Module Does:</strong><br>
      This tool helps you make data-driven decisions by comparing two filtered event groups to see which triggers 
      stronger PLA reactions. Perfect for answering questions like:
      <ul style="margin: 10px 0 10px 25px;">
        <li><strong>Arms vs Ships:</strong> Which event type is more inflammatory overall?</li>
        <li><strong>Offensive vs Defensive weapons:</strong> Does weapon type matter?</li>
        <li><strong>High-value vs Low-value arms sales:</strong> Does dollar amount drive reactions?</li>
        <li><strong>High-level vs Low-level diplomatic visits:</strong> Who triggers bigger responses?</li>
        <li><strong>US destroyers vs French frigates:</strong> Which country's ships cause more ADIZ?</li>
        <li><strong>2024 vs 2022:</strong> Are reactions escalating over time?</li>
        <li><strong>Air domain vs Land domain weapons:</strong> Which military domain is more sensitive?</li>
      </ul>
      <strong style="color: #667eea;">How to use:</strong> Select filters for Group A (blue) and Group B (purple), 
      then click "Compare Groups" below to see which triggers stronger reactions. You'll get side-by-side stats, 
      overlaid response curves, and an AI-like recommendation.
    </div>
    
    <div class="nav">
      <a href="index.html">‚Üê Home</a>
      <a href="visualizer.html">Visualizer</a>
      <a href="analyzers.html">Module 1</a>
      <a href="module2.html">Module 2</a>
    </div>
  </div>

  <div class="container">
    <h2>Setup Comparison</h2>
    
    <div class="comparison-setup">
      <!-- Group A -->
      <div class="group-panel group-a">
        <h3>üîµ Group A</h3>
        
        <div class="control-group">
          <label>Category</label>
          <select id="categoryA">
            <option value="">-- Select --</option>
            <option value="arms">Arms Sales</option>
            <option value="diplomatic">Diplomatic</option>
            <option value="ships">Ship Transits</option>
            <option value="bills">Legislative Bills</option>
            <option value="political">Political/Symbolic</option>
            <option value="taiwan_actions">Taiwan Actions</option>
          </select>
        </div>
        
        <div class="control-group">
          <label>Year</label>
          <select id="yearA">
            <option value="ALL">All Years</option>
          </select>
        </div>
        
        <!-- Arms Sub-filters A -->
        <div id="armsFiltersA" class="subfilter-section" style="display: none;">
          <h4>Arms Sales Filters</h4>
          <div class="control-group">
            <label>Value Tier</label>
            <select id="arms_valueTierA"><option value="">All</option></select>
          </div>
          <div class="control-group">
            <label>Domain</label>
            <select id="arms_domainA"><option value="">All</option></select>
          </div>
          <div class="control-group">
            <label>Type</label>
            <select id="arms_typeA"><option value="">All</option></select>
          </div>
        </div>
        
        <!-- Ships Sub-filters A -->
        <div id="shipsFiltersA" class="subfilter-section" style="display: none;">
          <h4>Ship Transit Filters</h4>
          <div class="control-group">
            <label>Country</label>
            <select id="ships_countryA"><option value="">All</option></select>
          </div>
          <div class="control-group">
            <label>Ship Type</label>
            <select id="ships_typeA"><option value="">All</option></select>
          </div>
        </div>
        
        <!-- Diplomatic Sub-filters A -->
        <div id="diplomaticFiltersA" class="subfilter-section" style="display: none;">
          <h4>Diplomatic Filters</h4>
          <div class="control-group">
            <label>Official Level</label>
            <select id="diplomatic_levelA"><option value="">All</option></select>
          </div>
        </div>
        
        <!-- Bills Sub-filters A -->
        <div id="billsFiltersA" class="subfilter-section" style="display: none;">
          <h4>Legislative Bill Filters</h4>
          <div class="control-group">
            <label>Milestone</label>
            <select id="bills_milestoneA"><option value="">All</option></select>
          </div>
        </div>
        
        <!-- Taiwan Actions Sub-filters A -->
        <div id="taiwanActionsFiltersA" class="subfilter-section" style="display: none;">
          <h4>Taiwan Actions Filters</h4>
          <div class="control-group">
            <label>DIME Category</label>
            <select id="taiwan_actions_dimeA"><option value="">All</option></select>
          </div>
        </div>
        
        <div class="event-counter" id="eventCounterA">Select category...</div>
      </div>
      
      <!-- Group B -->
      <div class="group-panel group-b">
        <h3>üü£ Group B</h3>
        
        <div class="control-group">
          <label>Category</label>
          <select id="categoryB">
            <option value="">-- Select --</option>
            <option value="arms">Arms Sales</option>
            <option value="diplomatic">Diplomatic</option>
            <option value="ships">Ship Transits</option>
            <option value="bills">Legislative Bills</option>
            <option value="political">Political/Symbolic</option>
            <option value="taiwan_actions">Taiwan Actions</option>
          </select>
        </div>
        
        <div class="control-group">
          <label>Year</label>
          <select id="yearB">
            <option value="ALL">All Years</option>
          </select>
        </div>
        
        <!-- Arms Sub-filters B -->
        <div id="armsFiltersB" class="subfilter-section" style="display: none;">
          <h4>Arms Sales Filters</h4>
          <div class="control-group">
            <label>Value Tier</label>
            <select id="arms_valueTierB"><option value="">All</option></select>
          </div>
          <div class="control-group">
            <label>Domain</label>
            <select id="arms_domainB"><option value="">All</option></select>
          </div>
          <div class="control-group">
            <label>Type</label>
            <select id="arms_typeB"><option value="">All</option></select>
          </div>
        </div>
        
        <!-- Ships Sub-filters B -->
        <div id="shipsFiltersB" class="subfilter-section" style="display: none;">
          <h4>Ship Transit Filters</h4>
          <div class="control-group">
            <label>Country</label>
            <select id="ships_countryB"><option value="">All</option></select>
          </div>
          <div class="control-group">
            <label>Ship Type</label>
            <select id="ships_typeB"><option value="">All</option></select>
          </div>
        </div>
        
        <!-- Diplomatic Sub-filters B -->
        <div id="diplomaticFiltersB" class="subfilter-section" style="display: none;">
          <h4>Diplomatic Filters</h4>
          <div class="control-group">
            <label>Official Level</label>
            <select id="diplomatic_levelB"><option value="">All</option></select>
          </div>
        </div>
        
        <!-- Bills Sub-filters B -->
        <div id="billsFiltersB" class="subfilter-section" style="display: none;">
          <h4>Legislative Bill Filters</h4>
          <div class="control-group">
            <label>Milestone</label>
            <select id="bills_milestoneB"><option value="">All</option></select>
          </div>
        </div>
        
        <!-- Taiwan Actions Sub-filters B -->
        <div id="taiwanActionsFiltersB" class="subfilter-section" style="display: none;">
          <h4>Taiwan Actions Filters</h4>
          <div class="control-group">
            <label>DIME Category</label>
            <select id="taiwan_actions_dimeB"><option value="">All</option></select>
          </div>
        </div>
        
        <div class="event-counter" id="eventCounterB">Select category...</div>
      </div>
    </div>
    
    <div class="control-group" style="max-width: 300px; margin: 0 auto 20px;">
      <label>Window Size</label>
      <select id="windowSize">
        <option value="7">¬±7 days</option>
        <option value="14" selected>¬±14 days</option>
        <option value="21">¬±21 days</option>
      </select>
    </div>
    
    <div class="button-container">
      <p><strong>Ready to compare?</strong> Click below to analyze which group triggers stronger reactions:</p>
      <button onclick="runComparison()">‚öñÔ∏è Compare Groups</button>
    </div>
    
    <div class="loading" id="loading">
      ‚öñÔ∏è Analyzing comparison...
    </div>
    
    <div id="results" class="results">
      <!-- Recommendation -->
      <div class="recommendation-box">
        <h3>üìä Analysis Result</h3>
        <div class="summary" id="recommendation"></div>
        <ul class="details" id="recommendationDetails"></ul>
      </div>
      
      <!-- Side-by-side Stats -->
      <div class="comparison-grid">
        <div class="group-stats group-a">
          <h3>üîµ Group A (<span id="groupACount">0</span> events)</h3>
          <div class="stat-row">
            <span class="stat-label">
              Avg Increase
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Average increase in ADIZ from baseline (30-day pre-event mean) to post-event period. Shows net change in aircraft sent.</span>
              </span>
            </span>
            <span class="stat-value" id="groupA_increase">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">
              Avg Peak
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Average highest ADIZ count seen in the window. Shows typical maximum response strength.</span>
              </span>
            </span>
            <span class="stat-value" id="groupA_peak">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">
              7-Day Spike
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Average ADIZ during the 7 days after events. Shows immediate reaction intensity.</span>
              </span>
            </span>
            <span class="stat-value" id="groupA_spike">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">
              Peak on Day
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Which day after the event sees the highest ADIZ on average. Shows reaction timing (Day 0 = immediate, Day 3 = delayed).</span>
              </span>
            </span>
            <span class="stat-value" id="groupA_peakDay">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">
              Baseline
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Average ADIZ in the 30 days BEFORE events. Shows "normal" activity level.</span>
              </span>
            </span>
            <span class="stat-value" id="groupA_baseline">--</span>
          </div>
        </div>
        
        <div class="group-stats group-b">
          <h3>üü£ Group B (<span id="groupBCount">0</span> events)</h3>
          <div class="stat-row">
            <span class="stat-label">
              Avg Increase
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Average increase in ADIZ from baseline (30-day pre-event mean) to post-event period. Shows net change in aircraft sent.</span>
              </span>
            </span>
            <span class="stat-value" id="groupB_increase">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">
              Avg Peak
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Average highest ADIZ count seen in the window. Shows typical maximum response strength.</span>
              </span>
            </span>
            <span class="stat-value" id="groupB_peak">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">
              7-Day Spike
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Average ADIZ during the 7 days after events. Shows immediate reaction intensity.</span>
              </span>
            </span>
            <span class="stat-value" id="groupB_spike">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">
              Peak on Day
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Which day after the event sees the highest ADIZ on average. Shows reaction timing (Day 0 = immediate, Day 3 = delayed).</span>
              </span>
            </span>
            <span class="stat-value" id="groupB_peakDay">--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">
              Baseline
              <span class="tooltip">‚ÑπÔ∏è
                <span class="tooltiptext">Average ADIZ in the 30 days BEFORE events. Shows "normal" activity level.</span>
              </span>
            </span>
            <span class="stat-value" id="groupB_baseline">--</span>
          </div>
        </div>
      </div>
      
      <!-- Overlaid Curves -->
      <div class="chart-container">
        <h3>üìà Response Curve Comparison</h3>
        <p style="color: #666; margin-bottom: 15px;">
          Blue = Group A, Purple = Group B. Shows average ADIZ pattern for each group overlaid.
        </p>
        <div id="overlaidChart"></div>
      </div>
      
      <!-- Bar Chart Comparison -->
      <div class="chart-container">
        <h3>üìä Metric Comparison</h3>
        <div id="barChart"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import ABCompare from './js/analyzers/abCompare.js';
    import DataConnector from './js/core/dataConnector.js';
    
    // Initialize
    async function init() {
      await loadEmbeddedData();
    }
    
    async function loadEmbeddedData() {
      try {
        const response = await fetch('./visualizer.html');
        const htmlContent = await response.text();
        const dataMatch = htmlContent.match(/const DATA\s*=\s*(\{[\s\S]*?\});/);
        const DATA = new Function('return ' + dataMatch[1])();
        
        DataConnector.loadFromObject(DATA);
        setupUI();
      } catch (error) {
        alert('Error loading data: ' + error.message);
      }
    }
    
    function setupUI() {
      // Populate year dropdowns
      const years = DataConnector.getAvailableYears().slice(1);
      ['yearA', 'yearB'].forEach(id => {
        const select = document.getElementById(id);
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          select.appendChild(option);
        });
      });
      
      // Populate sub-filters for both groups
      populateSubFilters('A');
      populateSubFilters('B');
      
      // Event listeners
      document.getElementById('categoryA').addEventListener('change', () => onCategoryChange('A'));
      document.getElementById('categoryB').addEventListener('change', () => onCategoryChange('B'));
      
      // Update counters when filters change
      ['categoryA', 'yearA'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => updateEventCounter('A'));
      });
      ['categoryB', 'yearB'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => updateEventCounter('B'));
      });
    }
    
    function populateSubFilters(group) {
      const arms = DataConnector.currentData.arms_sales || [];
      const ships = DataConnector.currentData.ships || [];
      const diplomatic = DataConnector.currentData.diplomatic || [];
      const bills = DataConnector.currentData.bills || [];
      const taiwanActions = DataConnector.currentData.taiwan_actions || [];
      
      populateDropdown(`arms_valueTier${group}`, getUniqueValues(arms, 'value_tier'));
      populateDropdown(`arms_domain${group}`, getUniqueValues(arms, 'domain'));
      populateDropdown(`arms_type${group}`, getUniqueValues(arms, 'offensive_defensive'));
      populateDropdown(`ships_country${group}`, getUniqueValues(ships, 'Country'));
      populateDropdown(`ships_type${group}`, getUniqueValues(ships, 'Ship_Type'));
      populateDropdown(`diplomatic_level${group}`, getUniqueValues(diplomatic, 'US_Official_Level'));
      populateDropdown(`bills_milestone${group}`, getUniqueValues(bills, 'Milestone'));
      populateDropdown(`taiwan_actions_dime${group}`, getUniqueValues(taiwanActions, 'dime_category'));
    }
    
    function getUniqueValues(dataset, field) {
      const values = new Set();
      dataset.forEach(item => {
        if (item[field]) values.add(String(item[field]));
      });
      return Array.from(values).filter(v => v && v !== 'null').sort();
    }
    
    function populateDropdown(id, values) {
      const select = document.getElementById(id);
      values.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
      });
    }
    
    function onCategoryChange(group) {
      const category = document.getElementById(`category${group}`).value;
      
      // Hide all sub-filters
      ['arms', 'ships', 'diplomatic', 'bills', 'taiwanActions'].forEach(type => {
        document.getElementById(`${type}Filters${group}`).style.display = 'none';
      });
      
      // Show relevant sub-filters
      if (category === 'arms') {
        document.getElementById(`armsFilters${group}`).style.display = 'block';
      } else if (category === 'ships') {
        document.getElementById(`shipsFilters${group}`).style.display = 'block';
      } else if (category === 'diplomatic') {
        document.getElementById(`diplomaticFilters${group}`).style.display = 'block';
      } else if (category === 'bills') {
        document.getElementById(`billsFilters${group}`).style.display = 'block';
      } else if (category === 'taiwan_actions') {
        document.getElementById(`taiwanActionsFilters${group}`).style.display = 'block';
      }
      
      updateEventCounter(group);
    }
    
    function updateEventCounter(group) {
      const filters = buildFilters(group);
      if (!filters.category) {
        document.getElementById(`eventCounter${group}`).textContent = 'Select category...';
        return;
      }
      
      const events = DataConnector.getEvents(filters);
      document.getElementById(`eventCounter${group}`).textContent = `${events.length} events match`;
    }
    
    function buildFilters(group) {
      const category = document.getElementById(`category${group}`).value;
      if (!category) return {};
      
      const filters = { category };
      
      const year = document.getElementById(`year${group}`).value;
      if (year !== 'ALL') filters.year = year;
      
      // Category-specific filters
      if (category === 'arms') {
        const valueTier = document.getElementById(`arms_valueTier${group}`).value;
        const domain = document.getElementById(`arms_domain${group}`).value;
        const type = document.getElementById(`arms_type${group}`).value;
        
        if (valueTier || domain || type) {
          filters.customFilter = e => {
            let match = true;
            if (valueTier) match = match && e.fields.value_tier === valueTier;
            if (domain) match = match && e.fields.domain === domain;
            if (type) match = match && e.fields.offensive_defensive === type;
            return match;
          };
        }
      } else if (category === 'ships') {
        const country = document.getElementById(`ships_country${group}`).value;
        const shipType = document.getElementById(`ships_type${group}`).value;
        
        if (country || shipType) {
          filters.customFilter = e => {
            let match = true;
            if (country) match = match && String(e.fields.Country).includes(country);
            if (shipType) match = match && e.fields.Ship_Type === shipType;
            return match;
          };
        }
      } else if (category === 'diplomatic') {
        const level = document.getElementById(`diplomatic_level${group}`).value;
        if (level) filters.customFilter = e => e.fields.US_Official_Level === level;
      } else if (category === 'bills') {
        const milestone = document.getElementById(`bills_milestone${group}`).value;
        if (milestone) filters.customFilter = e => e.fields.Milestone === milestone;
      } else if (category === 'taiwan_actions') {
        const dimeCategory = document.getElementById(`taiwan_actions_dime${group}`).value;
        if (dimeCategory) filters.customFilter = e => e.fields.dime_category === dimeCategory;
      }
      
      return filters;
    }
    
    window.runComparison = function() {
      const filtersA = buildFilters('A');
      const filtersB = buildFilters('B');
      
      if (!filtersA.category || !filtersB.category) {
        alert('Please select categories for both groups');
        return;
      }
      
      const windowSize = parseInt(document.getElementById('windowSize').value);
      
      document.getElementById('loading').classList.add('active');
      document.getElementById('results').style.display = 'none';
      
      setTimeout(() => {
        try {
          const comparison = ABCompare.compare(filtersA, filtersB, { windowSize });
          displayResults(comparison);
          
          document.getElementById('loading').classList.remove('active');
          document.getElementById('results').style.display = 'block';
        } catch (error) {
          document.getElementById('loading').classList.remove('active');
          alert('Error: ' + error.message);
        }
      }, 300);
    };
    
    function displayResults(comparison) {
      const { groupA, groupB, comparison: comp } = comparison;
      
      // Recommendation
      document.getElementById('recommendation').textContent = comp.recommendation.summary;
      document.getElementById('recommendationDetails').innerHTML = 
        comp.recommendation.details.map(d => `<li>${d}</li>`).join('');
      
      // Group stats
      document.getElementById('groupACount').textContent = groupA.eventCount;
      document.getElementById('groupBCount').textContent = groupB.eventCount;
      
      document.getElementById('groupA_increase').textContent = 
        groupA.stats.avgIncrease > 0 ? '+' + groupA.stats.avgIncrease.toFixed(1) : groupA.stats.avgIncrease.toFixed(1);
      document.getElementById('groupA_peak').textContent = groupA.stats.avgPeak.toFixed(1);
      document.getElementById('groupA_spike').textContent = groupA.stats.avg7DaySpike.toFixed(1);
      document.getElementById('groupA_peakDay').textContent = groupA.stats.maxSpikeDay;
      document.getElementById('groupA_baseline').textContent = groupA.stats.avgBaseline.toFixed(1);
      
      document.getElementById('groupB_increase').textContent = 
        groupB.stats.avgIncrease > 0 ? '+' + groupB.stats.avgIncrease.toFixed(1) : groupB.stats.avgIncrease.toFixed(1);
      document.getElementById('groupB_peak').textContent = groupB.stats.avgPeak.toFixed(1);
      document.getElementById('groupB_spike').textContent = groupB.stats.avg7DaySpike.toFixed(1);
      document.getElementById('groupB_peakDay').textContent = groupB.stats.maxSpikeDay;
      document.getElementById('groupB_baseline').textContent = groupB.stats.avgBaseline.toFixed(1);
      
      // Charts
      plotOverlaidCurves();
      plotBarChart();
    }
    
    function plotOverlaidCurves() {
      const data = ABCompare.getOverlaidCurvesData();
      
      const traces = [
        // Group A confidence band
        {
          x: data.groupA.offsets,
          y: data.groupA.lowerBound,
          type: 'scatter',
          mode: 'lines',
          line: { width: 0 },
          showlegend: false
        },
        {
          x: data.groupA.offsets,
          y: data.groupA.upperBound,
          type: 'scatter',
          mode: 'lines',
          fill: 'tonexty',
          fillcolor: 'rgba(102, 126, 234, 0.2)',
          line: { width: 0 },
          showlegend: false
        },
        // Group A mean
        {
          x: data.groupA.offsets,
          y: data.groupA.mean,
          type: 'scatter',
          mode: 'lines+markers',
          name: 'Group A',
          line: { color: '#667eea', width: 3 },
          marker: { size: 6 }
        },
        // Group B confidence band
        {
          x: data.groupB.offsets,
          y: data.groupB.lowerBound,
          type: 'scatter',
          mode: 'lines',
          line: { width: 0 },
          showlegend: false
        },
        {
          x: data.groupB.offsets,
          y: data.groupB.upperBound,
          type: 'scatter',
          mode: 'lines',
          fill: 'tonexty',
          fillcolor: 'rgba(118, 75, 162, 0.2)',
          line: { width: 0 },
          showlegend: false
        },
        // Group B mean
        {
          x: data.groupB.offsets,
          y: data.groupB.mean,
          type: 'scatter',
          mode: 'lines+markers',
          name: 'Group B',
          line: { color: '#764ba2', width: 3 },
          marker: { size: 6 }
        },
        // Event line
        {
          x: [0, 0],
          y: [0, Math.max(...data.groupA.upperBound, ...data.groupB.upperBound)],
          type: 'scatter',
          mode: 'lines',
          name: 'Event',
          line: { color: 'green', width: 2, dash: 'dot' }
        }
      ];
      
      const layout = {
        xaxis: { title: 'Days from Event' },
        yaxis: { title: 'ADIZ Count' },
        hovermode: 'x unified',
        height: 450
      };
      
      Plotly.newPlot('overlaidChart', traces, layout);
    }
    
    function plotBarChart() {
      const data = ABCompare.getComparisonBarData();
      
      const traces = [
        {
          x: data.metrics,
          y: data.groupA,
          type: 'bar',
          name: 'Group A',
          marker: { color: '#667eea' }
        },
        {
          x: data.metrics,
          y: data.groupB,
          type: 'bar',
          name: 'Group B',
          marker: { color: '#764ba2' }
        }
      ];
      
      const layout = {
        barmode: 'group',
        yaxis: { title: 'Value' },
        height: 400
      };
      
      Plotly.newPlot('barChart', traces, layout);
    }
    
    init();
  </script>
</body>
</html>
